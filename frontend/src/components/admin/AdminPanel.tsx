import React, { useState } from "react";
import {
  Container,
  Row,
  Col,
  Card,
  Nav,
  Alert,
  Button,
  Modal,
} from "react-bootstrap";
import FlightManagement from "./FlightManagement";
import AirportManagement from "./AirportManagement";
import ParameterSettings from "./ParameterSettings";
import PlaneManagement from "./PlaneManagement";
import TicketClassManagement from "./TicketClassManagement";
import EmployeeManagement from "./EmployeeManagement";
import { usePermissions } from "../../hooks/useAuth";
import Statistics from "../Statistics/Statistics";

type AdminTab =
  | "overview"
  | "flights"
  | "airports"
  | "planes"
  | "ticket-classes"
  | "parameters"
  | "employees"
  | "reports";

export const AdminPanel: React.FC = () => {
  const permissions = usePermissions();
  const [activeTab, setActiveTab] = useState<AdminTab>("overview");
  const [showFeatureModal, setShowFeatureModal] = useState(false);

  // Add state for managing quick action modals
  const [quickActionModals, setQuickActionModals] = useState({
    showFlightModal: false,
    showAirportModal: false,
    showTicketClassModal: false,
    showPlaneModal: false,
    showTicketModal: false,
  });

  // Redirect if user doesn't have admin permissions
  if (!permissions.canViewAdmin()) {
    return (
      <Container className="py-5">
        <Row className="justify-content-center">
          <Col md={8}>
            <Alert variant="danger" className="text-center">
              <Alert.Heading>Truy c·∫≠p b·ªã t·ª´ ch·ªëi</Alert.Heading>
              <p>B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã.</p>
              <p className="text-muted">
                Ph·∫ßn n√†y ch·ªâ d√†nh cho Qu·∫£n tr·ªã vi√™n h·ªá th·ªëng.
              </p>
            </Alert>
          </Col>
        </Row>
      </Container>
    );
  }

  const renderContent = () => {
    switch (activeTab) {
      case "flights":
        return permissions.canViewFlightManagement() ? (
          <FlightManagement
            showAddModal={quickActionModals.showFlightModal}
            onCloseAddModal={() =>
              setQuickActionModals((prev) => ({
                ...prev,
                showFlightModal: false,
              }))
            }
          />
        ) : (
          <AccessDeniedAlert section="Qu·∫£n l√Ω chuy·∫øn bay" />
        );

      case "airports":
        return permissions.canViewAirportManagement() ? (
          <AirportManagement
            showAddModal={quickActionModals.showAirportModal}
            onCloseAddModal={() =>
              setQuickActionModals((prev) => ({
                ...prev,
                showAirportModal: false,
              }))
            }
          />
        ) : (
          <AccessDeniedAlert section="Qu·∫£n l√Ω s√¢n bay" />
        );

      case "planes":
        return permissions.canViewPlaneManagement() ? (
          <PlaneManagement
            showAddModal={quickActionModals.showPlaneModal}
            onCloseAddModal={() =>
              setQuickActionModals((prev) => ({
                ...prev,
                showPlaneModal: false,
              }))
            }
          />
        ) : (
          <AccessDeniedAlert section="Qu·∫£n l√Ω ƒë·ªôi m√°y bay" />
        );

      case "ticket-classes":
        return permissions.canViewTicketClassManagement() ? (
          <TicketClassManagement
            showAddModal={quickActionModals.showTicketClassModal}
            onCloseAddModal={() =>
              setQuickActionModals((prev) => ({
                ...prev,
                showTicketClassModal: false,
              }))
            }
          />
        ) : (
          <AccessDeniedAlert section="Qu·∫£n l√Ω h·∫°ng v√©" />
        );

      case "parameters":
        return permissions.canViewParameterSettings() ? (
          <ParameterSettings />
        ) : (
          <AccessDeniedAlert section="Tham s·ªë h·ªá th·ªëng" />
        );

      case "employees":
        return permissions.canViewEmployeeManagement() ? (
          <EmployeeManagement />
        ) : (
          <AccessDeniedAlert section="Qu·∫£n l√Ω nh√¢n vi√™n" />
        );

      case "reports":
        return permissions.canViewReports() ? (
          <Statistics />
        ) : (
          <AccessDeniedAlert section="B√°o c√°o" />
        );

      default:
      case "overview":
        return (
          <AdminOverview
            onNavigate={handleQuickAction}
            permissions={permissions}
            onShowFeatureModal={() => setShowFeatureModal(true)}
          />
        );
    }
  };

  const handleQuickAction = (
    action:
      | AdminTab
      | "add-flight"
      | "add-airport"
      | "add-plane"
      | "add-ticket-class"
      | "add-ticket"
  ) => {
    switch (action) {
      case "add-flight":
        if (permissions.canViewFlightManagement()) {
          setActiveTab("flights");
          setQuickActionModals((prev) => ({ ...prev, showFlightModal: true }));
        }
        break;
      case "add-airport":
        if (permissions.canViewAirportManagement()) {
          setActiveTab("airports");
          setQuickActionModals((prev) => ({ ...prev, showAirportModal: true }));
        }
        break;
      case "add-plane":
        if (permissions.canViewPlaneManagement()) {
          setActiveTab("planes");
          setQuickActionModals((prev) => ({ ...prev, showPlaneModal: true }));
        }
        break;
      case "add-ticket-class":
        if (permissions.canViewTicketClassManagement()) {
          setActiveTab("ticket-classes");
          setQuickActionModals((prev) => ({
            ...prev,
            showTicketClassModal: true,
          }));
        }
        break;
      case "add-ticket":
        setQuickActionModals((prev) => ({ ...prev, showTicketModal: true }));
        break;
      default:
        setActiveTab(action);
        break;
    }
  };

  return (
    <Container fluid className="py-4">
      <Row>
        <Col>
          <div className="text-center mb-4">
            <h1 className="mb-2">Trang qu·∫£n tr·ªã</h1>
            <p className="text-muted">
              Qu·∫£n l√Ω chuy·∫øn bay, s√¢n bay v√† c√†i ƒë·∫∑t h·ªá th·ªëng
            </p>
          </div>

          <Nav
            variant="pills"
            className="justify-content-center mb-4 flex-wrap"
          >
            <Nav.Item>
              <Nav.Link
                active={activeTab === "overview"}
                onClick={() => setActiveTab("overview")}
              >
                üìä T·ªïng quan
              </Nav.Link>
            </Nav.Item>

            {permissions.canViewFlightManagement() && (
              <Nav.Item>
                <Nav.Link
                  active={activeTab === "flights"}
                  onClick={() => setActiveTab("flights")}
                >
                  ‚úàÔ∏è Chuy·∫øn bay
                </Nav.Link>
              </Nav.Item>
            )}

            {permissions.canViewAirportManagement() && (
              <Nav.Item>
                <Nav.Link
                  active={activeTab === "airports"}
                  onClick={() => setActiveTab("airports")}
                >
                  üè¢ S√¢n bay
                </Nav.Link>
              </Nav.Item>
            )}

            {permissions.canViewPlaneManagement() && (
              <Nav.Item>
                <Nav.Link
                  active={activeTab === "planes"}
                  onClick={() => setActiveTab("planes")}
                >
                  üõ©Ô∏è ƒê·ªôi m√°y bay
                </Nav.Link>
              </Nav.Item>
            )}

            {permissions.canViewTicketClassManagement() && (
              <Nav.Item>
                <Nav.Link
                  active={activeTab === "ticket-classes"}
                  onClick={() => setActiveTab("ticket-classes")}
                >
                  üéüÔ∏è H·∫°ng v√©
                </Nav.Link>
              </Nav.Item>
            )}

            {permissions.canViewEmployeeManagement() && (
              <Nav.Item>
                <Nav.Link
                  active={activeTab === "employees"}
                  onClick={() => setActiveTab("employees")}
                >
                  üë• Nh√¢n vi√™n
                </Nav.Link>
              </Nav.Item>
            )}

            {permissions.canViewReports() && (
              <Nav.Item>
                <Nav.Link
                  active={activeTab === "reports"}
                  onClick={() => setActiveTab("reports")}
                >
                  üìä B√°o c√°o
                </Nav.Link>
              </Nav.Item>
            )}

            {permissions.canViewParameterSettings() && (
              <Nav.Item>
                <Nav.Link
                  active={activeTab === "parameters"}
                  onClick={() => setActiveTab("parameters")}
                >
                  ‚öôÔ∏è C√†i ƒë·∫∑t
                </Nav.Link>
              </Nav.Item>
            )}
          </Nav>

          <div>{renderContent()}</div>
        </Col>
      </Row>

      {/* Feature Modal */}
      <Modal
        show={showFeatureModal}
        onHide={() => setShowFeatureModal(false)}
        centered
      >
        <Modal.Header closeButton className="bg-info text-white">
          <Modal.Title>
            <i className="bi bi-info-circle me-2"></i>
            Th√¥ng b√°o
          </Modal.Title>
        </Modal.Header>
        <Modal.Body className="p-4 text-center">
          <div className="mb-3">
            <i
              className="bi bi-clock text-info"
              style={{ fontSize: "3rem" }}
            ></i>
          </div>
          <h5 className="mb-3">T√≠nh nƒÉng b√°o c√°o s·∫Ω c√≥ s·ªõm!</h5>
          <p className="text-muted mb-0">
            Ch√∫ng t√¥i ƒëang ph√°t tri·ªÉn t√≠nh nƒÉng b√°o c√°o. Vui l√≤ng quay l·∫°i sau.
          </p>
        </Modal.Body>
        <Modal.Footer>
          <Button variant="info" onClick={() => setShowFeatureModal(false)}>
            <i className="bi bi-check me-2"></i>
            ƒê√£ hi·ªÉu
          </Button>
        </Modal.Footer>
      </Modal>
    </Container>
  );
};

// Access Denied Alert Component
const AccessDeniedAlert: React.FC<{ section: string }> = ({ section }) => (
  <Alert variant="warning" className="text-center">
    <Alert.Heading>Kh√¥ng ƒë·ªß quy·ªÅn</Alert.Heading>
    <p>
      B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p <strong>{section}</strong>.
    </p>
    <p className="text-muted mb-0">
      Li√™n h·ªá qu·∫£n tr·ªã vi√™n h·ªá th·ªëng n·∫øu b·∫°n cho r·∫±ng ƒë√¢y l√† l·ªói.
    </p>
  </Alert>
);

// Admin Overview Component with Permission-based Quick Actions
const AdminOverview: React.FC<{
  onNavigate: (
    action:
      | AdminTab
      | "add-flight"
      | "add-airport"
      | "add-plane"
      | "add-ticket-class"
      | "add-ticket"
  ) => void;
  permissions: ReturnType<typeof usePermissions>;
  onShowFeatureModal: () => void;
}> = ({ onNavigate, permissions, onShowFeatureModal }) => {
  return (
    <Container fluid>
      {/* Statistics Cards */}
      <Row className="mb-4">
        <Col lg={3} md={6} className="mb-3">
          <Card className="h-100 text-center">
            <Card.Body>
              <div className="mb-2" style={{ fontSize: "2rem" }}>
                ‚úàÔ∏è
              </div>
              <Card.Title className="h5 text-muted">T·ªïng chuy·∫øn bay</Card.Title>
              <Card.Text className="h3 mb-0 text-primary">156</Card.Text>
            </Card.Body>
          </Card>
        </Col>
        <Col lg={3} md={6} className="mb-3">
          <Card className="h-100 text-center">
            <Card.Body>
              <div className="mb-2" style={{ fontSize: "2rem" }}>
                üè¢
              </div>
              <Card.Title className="h5 text-muted">
                S√¢n bay ho·∫°t ƒë·ªông
              </Card.Title>
              <Card.Text className="h3 mb-0 text-info">23</Card.Text>
            </Card.Body>
          </Card>
        </Col>
        <Col lg={3} md={6} className="mb-3">
          <Card className="h-100 text-center">
            <Card.Body>
              <div className="mb-2" style={{ fontSize: "2rem" }}>
                üë•
              </div>
              <Card.Title className="h5 text-muted">T·ªïng h√†nh kh√°ch</Card.Title>
              <Card.Text className="h3 mb-0 text-success">8,432</Card.Text>
            </Card.Body>
          </Card>
        </Col>
        <Col lg={3} md={6} className="mb-3">
          <Card className="h-100 text-center">
            <Card.Body>
              <div className="mb-2" style={{ fontSize: "2rem" }}>
                üí∞
              </div>
              <Card.Title className="h5 text-muted">Doanh thu</Card.Title>
              <Card.Text className="h3 mb-0 text-warning">2.1 t·ª∑ VND</Card.Text>
            </Card.Body>
          </Card>
        </Col>
      </Row>

      <Row>
        {/* Quick Actions - Permission-based */}
        <Col lg={6} className="mb-4">
          <Card className="h-100">
            <Card.Header>
              <Card.Title className="h4 mb-0">Thao t√°c nhanh</Card.Title>
            </Card.Header>
            <Card.Body>
              <Row>
                {permissions.canViewFlightManagement() && (
                  <Col md={6} className="mb-3">
                    <Button
                      variant="outline-primary"
                      className="w-100 text-start"
                      size="lg"
                      onClick={() => onNavigate("add-flight")}
                    >
                      <span className="me-2">‚ûï</span>
                      Th√™m chuy·∫øn bay m·ªõi
                    </Button>
                  </Col>
                )}

                {permissions.canViewAirportManagement() && (
                  <Col md={6} className="mb-3">
                    <Button
                      variant="outline-info"
                      className="w-100 text-start"
                      size="lg"
                      onClick={() => onNavigate("add-airport")}
                    >
                      <span className="me-2">üè¢</span>
                      Th√™m s√¢n bay m·ªõi
                    </Button>
                  </Col>
                )}

                {permissions.canViewPlaneManagement() && (
                  <Col md={6} className="mb-3">
                    <Button
                      variant="outline-warning"
                      className="w-100 text-start"
                      size="lg"
                      onClick={() => onNavigate("add-plane")}
                    >
                      <span className="me-2">üõ©Ô∏è</span>
                      Th√™m m√°y bay m·ªõi
                    </Button>
                  </Col>
                )}

                {permissions.canViewTicketClassManagement() && (
                  <Col md={6} className="mb-3">
                    <Button
                      variant="outline-dark"
                      className="w-100 text-start"
                      size="lg"
                      onClick={() => onNavigate("add-ticket-class")}
                    >
                      <span className="me-2">üéüÔ∏è</span>
                      Th√™m h·∫°ng v√©
                    </Button>
                  </Col>
                )}

                {permissions.canViewReports() && (
                  <Col md={6} className="mb-3">
                    <Button
                      variant="outline-success"
                      className="w-100 text-start"
                      size="lg"
                      onClick={onShowFeatureModal}
                    >
                      <span className="me-2">üìä</span>
                      Xem b√°o c√°o
                    </Button>
                  </Col>
                )}

                {permissions.canViewParameterSettings() && (
                  <Col md={6} className="mb-3">
                    <Button
                      variant="outline-secondary"
                      className="w-100 text-start"
                      size="lg"
                      onClick={() => onNavigate("parameters")}
                    >
                      <span className="me-2">‚öôÔ∏è</span>
                      C√†i ƒë·∫∑t h·ªá th·ªëng
                    </Button>
                  </Col>
                )}
              </Row>
            </Card.Body>
          </Card>
        </Col>

        {/* Recent Activity */}
        <Col lg={6} className="mb-4">
          <Card className="h-100">
            <Card.Header>
              <Card.Title className="h4 mb-0">Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</Card.Title>
            </Card.Header>
            <Card.Body>
              <div className="d-flex align-items-center mb-3 pb-3 border-bottom">
                <div className="me-3" style={{ fontSize: "1.5rem" }}>
                  ‚úàÔ∏è
                </div>
                <div className="flex-grow-1">
                  <div className="fw-medium">
                    Chuy·∫øn bay m·ªõi FL001 ƒë√£ ƒë∆∞·ª£c th√™m
                  </div>
                  <small className="text-muted">2 gi·ªù tr∆∞·ªõc</small>
                </div>
              </div>
              <div className="d-flex align-items-center mb-3 pb-3 border-bottom">
                <div className="me-3" style={{ fontSize: "1.5rem" }}>
                  üè¢
                </div>
                <div className="flex-grow-1">
                  <div className="fw-medium">S√¢n bay LAX ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t</div>
                  <small className="text-muted">4 gi·ªù tr∆∞·ªõc</small>
                </div>
              </div>
              <div className="d-flex align-items-center">
                <div className="me-3" style={{ fontSize: "1.5rem" }}>
                  ‚öôÔ∏è
                </div>
                <div className="flex-grow-1">
                  <div className="fw-medium">
                    Tham s·ªë h·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
                  </div>
                  <small className="text-muted">1 ng√†y tr∆∞·ªõc</small>
                </div>
              </div>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default AdminPanel;
